function secureRandom(e,t){if(t=t||{type:"Array"},"undefined"!=typeof process&&"number"==typeof process.pid&&process.versions&&process.versions.node)return nodeRandom(e,t);if(!(window.crypto||window.msCrypto))throw new Error("Your browser does not support window.crypto.");return browserRandom(e,t)}function nodeRandom(e,t){const n=require("crypto").randomBytes(e);switch(t.type){case"Array":return[].slice.call(n);case"Buffer":return n;case"Uint8Array":for(var r=new Uint8Array(e),o=0;o<e;++o)r[o]=n.readUInt8(o);return r;default:throw new Error(t.type+" is unsupported.")}}function browserRandom(e,t){const n=new Uint8Array(e);switch((window.crypto||window.msCrypto).getRandomValues(n),t.type){case"Array":return[].slice.call(n);case"Buffer":try{new Buffer(1)}catch(e){throw new Error("Buffer not supported in this environment. Use Node.js or Browserify for browser support.")}return new Buffer(n);case"Uint8Array":case"Uint8Array":return n;default:throw new Error(t.type+" is unsupported.")}}function updateTheme(){const e=document.body;"light"===localStorage.getItem("theme")?e.classList.contains("light")||e.classList.add("light"):e.classList.contains("light")&&e.classList.remove("light")}function openJoinGrpDialog(){document.getElementById("create-group").classList.add("hidden"),document.getElementById("join-group").classList.add("hidden"),document.getElementById("dialog-opts").style.display="block",new window.mdc.dialog.MDCDialog(document.querySelector(".mdc-dialog")).open()}secureRandom.randomArray=function(e){return secureRandom(e,{type:"Array"})},secureRandom.randomUint8Array=function(e){return secureRandom(e,{type:"Uint8Array"})},secureRandom.randomBuffer=function(e){return secureRandom(e,{type:"Buffer"})},document.body.addEventListener("MDCDrawer:closed",function(){document.body.querySelector("input, button").focus()});const progressBar=document.querySelector(".mdc-linear-progress");function generateRandomUUID(){let e=(new Date).getTime();return"xxxxxxxx-xxxx-xxxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){const n=(e+16*Math.random())%16|0;return e=Math.floor(e/16),("x"===t?n:3&n|8).toString(16)})}null===localStorage.getItem("userUUID")&&localStorage.setItem("userUUID",generateRandomUUID());const userUUID=localStorage.getItem("userUUID"),snackbar=new mdc.snackbar.MDCSnackbar(document.querySelector(".mdc-snackbar")),database=firebase.database();let selectedGroup="";const msgArea=document.querySelector(".messages-area");let firstTimeScrolling=!0;function encryptMessage(e,t=null,n=null){let r;const o=(r=null===t?new aesjs.ModeOfOperation.cbc(_base64ToArrayBuffer(groupData[selectedGroup].AESKey),_base64ToArrayBuffer(groupData[selectedGroup].AESIV)):new aesjs.ModeOfOperation.cbc(_base64ToArrayBuffer(t),_base64ToArrayBuffer(n))).encrypt(aesjs.padding.pkcs7.pad(aesjs.utils.utf8.toBytes(e)));return _arrayBufferToBase64(o)}function decryptMessage(e,t=null,n=null){const r=_base64ToArrayBuffer(e);let o;return o=null===t?new aesjs.ModeOfOperation.cbc(_base64ToArrayBuffer(groupData[selectedGroup].AESKey),_base64ToArrayBuffer(groupData[selectedGroup].AESIV)):new aesjs.ModeOfOperation.cbc(_base64ToArrayBuffer(t),_base64ToArrayBuffer(n)),aesjs.utils.utf8.fromBytes(aesjs.padding.pkcs7.strip(o.decrypt(r)))}function addListInvite(e){const t=document.createElement("div");t.classList.add("join-grp-request");const n=document.createElement("p");n.innerHTML="A user has requested to join this group<br>\nDo you accept the request?";const r=document.createElement("div");r.classList.add("action-holder");const o=document.createElement("button");o.classList.add("mdc-button","mdc-button--raised","colorful-button");const a=document.createElement("div");a.classList.add("mdc-button__ripple");const s=document.createElement("span");s.classList.add("mdc-button__label"),s.innerHTML="Accept Request",o.appendChild(a),o.appendChild(s),o.onclick=function(){const t=e.split(","),n=new JSEncrypt;n.setPublicKey(t[0]),database.ref("encryptedAESKeys/"+t[1]).set({EncryptedAES:n.encrypt(groupData[selectedGroup].AESKey+","+groupData[selectedGroup].AESIV),GrpName:groupData[selectedGroup].grpName,GrpUUID:selectedGroup})};const c=document.createElement("button");c.classList.add("mdc-button","mdc-button--raised","dull-button");const i=document.createElement("div");i.classList.add("mdc-button__ripple");const d=document.createElement("span");d.classList.add("mdc-button__label"),d.innerHTML="Deny Request",c.appendChild(i),c.appendChild(d),c.onclick=function(){database.ref("encryptedAESKeys/"+e.split(",")[1]).set({EncryptedAES:"rej",GrpName:groupData[selectedGroup].grpName,GrpUUID:selectedGroup})},r.appendChild(o),r.appendChild(c),t.appendChild(n),t.appendChild(r),msgArea.appendChild(t),new mdc.ripple.MDCRipple(o),new mdc.ripple.MDCRipple(c)}function scrollToBottom(){const e=msgArea.scrollHeight-msgArea.clientHeight;let t=msgArea.scrollTop;const n=(e-t)/35,r=setInterval(function(){msgArea.scrollTop=t,(t+=n)>=e&&clearInterval(r)},1)}function refreshList(){progressBar.style.display="block",document.querySelector(".mdc-top-app-bar__title").innerHTML=groupData[selectedGroup].grpName,document.querySelector(".messages-area").textContent="",database.ref("messages/"+selectedGroup).on("value",function(e){progressBar.style.display="none";const t=document.getElementById("no-msg-text");t&&t.remove();const n=msgArea.childElementCount;let r=0;if(e.forEach(function(e){if(r<n)return void r++;if("specialGrpRequest"===e.val().Author)return addListInvite(e.val().Content,e.key),void scrollToBottom();const t=document.createElement("p"),o=decryptMessage(e.val().Content);t.innerHTML=o;const a=o.match(new RegExp("(^|[ \t\r\n])((ftp|http|https|gopher|mailto|news|nntp|telnet|wais|file|prospero|aim|webcal):(([A-Za-z0-9$_.+!*(),;/?:@&~=-])|%[A-Fa-f0-9]{2}){2,}(#([a-zA-Z0-9][a-zA-Z0-9$_.+!*(),;/?:@&~=%-]*))?([A-Za-z0-9$_+!*();/?:~-]))","g")),s=document.createElement("div");if(null!==a)for(let e=0;e<a.length;e++)if(a[e].includes("www.youtube.com/watch?")){const t=a[e].match(/(?:https?:\/{2})?(?:w{3}\.)?youtu(?:be)?\.(?:com|be)(?:\/watch\?v=|\/)([^\s&]+)/)[1].toString(),n=document.createElement("iframe");n.frameBorder="0",n.sandbox.add("allow-scripts","allow-same-origin"),n.setAttribute("allowfullscreen","allowfullscreen"),n.src="https://www.youtube-nocookie.com/embed/"+t,n.setAttribute("srcdoc","<style>*{padding:0;margin:0;overflow:hidden}html,body{height:100%}img,span{position:absolute;width:100%;top:0;bottom:0;margin:auto}span{height:1.5em;text-align:center;font:48px/1.5 sans-serif;color:white;text-shadow:0 0 0.5em black}</style><a href=https://www.youtube-nocookie.com/embed/"+t+"?autoplay=1><img src=https://img.youtube.com/vi/"+t+"/hqdefault.jpg><span>â–¶</span></a>"),n.classList.add("inlineYTPlayer");const r=document.createElement("div");r.classList.add("iframe-holder"),r.appendChild(n),s.appendChild(r);const o=document.createElement("button");o.classList.add("mdc-fab","mdc-fab--mini","play-popup-btn");const i=document.createElement("div");i.classList.add("mdc-fab__ripple");const d=document.createElement("span");function c(){playVideo(t)}d.classList.add("mdc-fab__icon","material-icons"),d.innerHTML="picture_in_picture",o.appendChild(i),o.appendChild(d),o.onclick=c,s.appendChild(o),new mdc.ripple.MDCRipple(o);break}s.style.display="table",e.val().Author===userUUID?s.classList.add("from-user"):s.classList.add("from-remote"),s.appendChild(t),msgArea.appendChild(s),r++}),0===msgArea.childElementCount){const e=document.createElement("p");e.innerHTML="No messages",e.style.textAlign="center",e.style.marginTop="10px",e.id="no-msg-text",msgArea.appendChild(e)}scrollToBottom()})}const messageTextbox=new window.mdc.textField.MDCTextField(document.getElementById("message-textbox"));let groupData,first=!0;function addNavBarItem(e){const t=document.createElement("a");t.classList.add("mdc-list-item"),first&&(selectedGroup=e,t.classList.add("mdc-list-item--activated"),first=!1),t.onclick=function(){selectedGroup=e,msgArea.innerHTML="",refreshList()};const n=document.createElement("span");n.classList.add("mdc-list-item__ripple");const r=document.createElement("i");r.classList.add("material-icons","mdc-list-item__graphic"),r.setAttribute("aria-hidden","true"),r.innerHTML="group";const o=document.createElement("span");o.classList.add("mdc-list-item__text"),o.innerHTML=groupData[e].grpName,t.appendChild(n),t.appendChild(r),t.appendChild(o),document.querySelector("nav.mdc-list").appendChild(t),new mdc.ripple.MDCRipple(t)}let password,inviteList={};function init(){new mdc.textField.MDCTextField(document.getElementById("message-textbox")),null!==localStorage.getItem("inviteData")&&(inviteList=JSON.parse(localStorage.getItem("inviteData")),Object.keys(inviteList).forEach(function(e){database.ref("encryptedAESKeys/"+e).on("value",function(t){null!==t.val()&&("rej"!==t.val().EncryptedAES?decryptAccept(t,e):showSnackbarErr('Your request to join "'+t.val().GrpName+'" was rejected'),deletePendingInvite(t.val().GrpUUID))})})),void 0!==groupData&&Object.keys(groupData).forEach(function(e){addNavBarItem(e)}),0===selectedGroup.length&&(document.querySelector(".add-first-grp").style.display="block"),0!==selectedGroup.length?refreshList():progressBar.style.display="none"}function init_pwdField(){null===localStorage.getItem("pwdHash")?document.getElementById("login-box").style.display="none":document.getElementById("create_pwd").style.display="none"}function c_acct(){const e=new mdc.textField.MDCTextField(document.getElementById("newPwdField")).value;void 0===e||e.length<8?showSnackbarErr("Length of password must be longer than 8"):(password=e,showLoginPgMsg("Hashing password"),localStorage.setItem("pwdHash",bcrypt.hashSync(e,11)),b_init())}function showLoginPgMsg(e){document.getElementById("login-msg").innerHTML=e}function c_login(){showLoginPgMsg("Verifying");const e=new mdc.textField.MDCTextField(document.getElementById("pwdField")).value;if(password=e,bcrypt.compareSync(e,localStorage.getItem("pwdHash"))){if(showLoginPgMsg("Decrypting data"),null===localStorage.getItem("grpData"))groupData={};else try{groupData=JSON.parse(CryptoJS.AES.decrypt(localStorage.getItem("grpData"),e).toString(CryptoJS.enc.Utf8))}catch(e){showLoginPgMsg("Decryption error. Group data might be corrupt.")}b_init()}else showLoginPgMsg("Incorrect password. Please try again"),showSnackbarErr("Incorrect password, try again")}function b_init(){void 0===groupData&&(groupData={}),init(),document.querySelector(".material-icons.mdc-top-app-bar__navigation-icon.mdc-icon-button").style.display="block";const e=document.querySelector(".login-overlay");e.style.opacity="0",e.style.pointerEvents="none"}function toggleVisibility(e,t){"password"===e.type?(t.querySelector(".mdc-fab__icon.material-icons").innerHTML="visibility_off",e.type="text"):(t.querySelector(".mdc-fab__icon.material-icons").innerHTML="visibility",e.type="password")}function sendMsg(){if(0===selectedGroup.length)return void showSnackbarErr("Create or join a group first");const e=messageTextbox.value.trim();if(0===e.length)return void showSnackbarErr("Your message is empty");if("!!!zeruiMode!!!"===e)return void changeZeruiMode();const t=database.ref("messages/"+selectedGroup).push().getKey();database.ref("messages/"+selectedGroup+"/"+t).set({Content:encryptMessage(e),Author:userUUID}),messageTextbox.value=""}function updateLocalGrpData(){localStorage.setItem("grpData",CryptoJS.AES.encrypt(JSON.stringify(groupData),password).toString())}async function addNewGrp(){if(document.querySelector("#join-group").classList.contains("hidden")&&!document.querySelector("#create-group").classList.contains("hidden")){let e=new mdc.textField.MDCTextField(document.getElementById("create-grp-name")).value.trim();0===e.length&&(e="No Name");const t=secureRandom(32),n=secureRandom(16),r=generateRandomUUID();groupData[r]={grpName:e,AESKey:_arrayBufferToBase64(t),AESIV:_arrayBufferToBase64(n)},updateLocalGrpData(),addNavBarItem(r)}else if(!document.querySelector("#join-group").classList.contains("hidden")&&document.querySelector("#create-group").classList.contains("hidden")){const e=new mdc.textField.MDCTextField(document.getElementById("join-grp-code")).value;if(6!==e.length)return void showSnackbarErr("Invalid invite code");database.ref("invites/"+e).once("value").then(function(t){if(null===t.val())showSnackbarErr("Invite code not found");else{if(t.val().GrpUUID in groupData)return void showSnackbarErr("You are already a participant");const n=new JSEncrypt,r=database.ref("messages/"+selectedGroup).push().getKey();database.ref("messages/"+t.val().GrpUUID+"/"+r).set({Content:n.getPublicKey()+","+e,Author:"specialGrpRequest"}),database.ref("invites/"+e).remove(),inviteList[e]={private:n.getPrivateKey()},updateInviteList(),showSnackbarErr("Request to join group sent."),database.ref("encryptedAESKeys/"+e).on("value",function(t){null!==t.val()&&("rej"!==t.val().EncryptedAES?decryptAccept(t,e):showSnackbarErr('Your request to join "'+t.val().GrpName+'" was rejected'),deletePendingInvite(t.val().GrpUUID))})}})}}function showSnackbarErr(e){document.querySelector(".mdc-snackbar #snackbar-text").innerHTML=e,snackbar.open()}function updateInviteList(){localStorage.setItem("inviteData",JSON.stringify(inviteList))}function decryptAccept(e,t){const n=new JSEncrypt;n.setPrivateKey(inviteList[t].private),deletePendingInvite(t);const r=n.decrypt(e.val().EncryptedAES).split(",");addNewGroup(r[0],r[1],e.val().GrpName,e.val().GrpUUID),showSnackbarErr('You request to join"'+e.val().GrpName+'" was accepted')}function deletePendingInvite(e){delete inviteList[e],updateInviteList(),database.ref("encryptedAESKeys/"+e).off()}function addNewGroup(e,t,n,r){groupData[r]={grpName:n,AESKey:e,AESIV:t},updateLocalGrpData(),addNavBarItem(r)}function getGrpInviteCode(){if(0===selectedGroup.length)return void showSnackbarErr("Create or join a group first");let e=(new Date).getTime();const t="xxxxxx".replace(/[xy]/g,function(t){const n=(e+16*Math.random())%16|0;return e=Math.floor(e/16),("x"===t?n:3&n|8).toString(16)});document.querySelector(".grpInviteCode").innerHTML=t,new window.mdc.dialog.MDCDialog(document.querySelector("#get-grp-code")).open(),database.ref("invites/"+t).set({GrpUUID:selectedGroup})}function playVideo(e){const t=document.querySelector("#popup-YT #popup-drag"),n=document.querySelector("#popup-YT");document.querySelector("#popup-YT iframe").src="https://www.youtube-nocookie.com/embed/"+e+"?autoplay=1",n.style.display="block";let r=0,o=0,a=0,s=0;function c(e){(e=e||window.event).preventDefault(),r=a-e.clientX,o=s-e.clientY,a=e.clientX,s=e.clientY,n.style.top=n.offsetTop-o+"px",n.style.left=n.offsetLeft-r+"px"}function i(){document.onmouseup=null,document.onmousemove=null}t.onmousedown=function(e){(e=e||window.event).preventDefault(),a=e.clientX,s=e.clientY,document.onmouseup=i,document.onmousemove=c},document.querySelector("#popup-YT #popup-drag .close-btn").onclick=function(){document.querySelector("#popup-YT iframe").src=null,n.style.display="none"},isPlaying=!0}function initAutoresize(){const e=document.querySelector("#message-textbox textarea");e.addEventListener("keydown",function(){setTimeout(function(){e.style.height="auto",e.style.height=e.scrollHeight+"px"},0)})}init_pwdField(),document.querySelector("#message-textbox textarea").addEventListener("keyup",function(e){13===e.keyCode&&(e.preventDefault(),sendMsg())}),_arrayBufferToBase64=function(e){return btoa(String.fromCharCode.apply(null,e))},_base64ToArrayBuffer=function(e){return atob(e).split("").map(function(e){return e.charCodeAt(0)})};